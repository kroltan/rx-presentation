<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="../css/theme/black.css">
    <link rel="stylesheet" href="base.css" />
    <script src="https://unpkg.com/rxjs/bundles/rxjs.umd.min.js"></script>
    <script src="https://www.unpkg.com/hyperscript@2.0.2/index.js"></script>

    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 400px;
        }

        #items {
            flex: 1;
        }
    </style>
</head>
<body class="reveal">
    <div id="items">

    </div>
    <button id="add">Nova Tarefa</button>

    <script>
        const h = hyperscript;
        const {
            BehaviorSubject,
            fromEvent,
            operators: {
                map,
                withLatestFrom,
                pairwise,
            }
        } = rxjs;


        // Data type definitions
        const Item = () =>
            new BehaviorSubject({
                text: "",
                done: false,
            });

        // Utility functions
        const addItemsToList = (destination$, item$) =>
            item$
                .pipe(
                    withLatestFrom(destination$),
                    map(([item, list]) => [...list, item]),
                )
                .subscribe(destination$);

        const update = (value$, changes) =>
            value$
                .next({
                    ...value$.value,
                    ...changes,
                });

        const inspectDifferences = array$ =>
            array$
                .pipe(
                    pairwise(),
                    map(([previous, current]) => {
                            const kept = [];
                            const added = [];

                            const cache = new Set(previous);

                            for (const item of current) {
                                if (cache.has(item)) {
                                    kept.push(item);
                                    cache.delete(item);
                                } else {
                                    added.push(item);
                                }
                            }

                            const removed = [...cache.values()];

                            return { kept, added, removed };
                        }
                    )
                );

        const hookElementLifecycle = (bind, update) => {
            const unsubscribeMapping = new Map();

            return ({ added, removed }) => {
                for (const item of added) {
                    const element = bind(item);
                    const unsubscribe = item.subscribe(value => update(element, value));

                    unsubscribeMapping.set(item, () => {
                        unsubscribe();
                        element.remove();
                    });
                }

                for (const item of removed) {
                    unsubscribeMapping.get(item)();
                    unsubscribeMapping.delete(item);
                }
            };
        };


        // Get required UI elements
        const addButton = document.getElementById("add");
        const itemsContainer = document.getElementById("items");

        const database$ = new BehaviorSubject([]);

        const newItem$ = fromEvent(addButton, "click")
            .pipe(map(Item));

        addItemsToList(database$, newItem$);

        database$
            .pipe(inspectDifferences)
            .subscribe(hookElementLifecycle(
                item => {
                    const element = h("div.item", [

                    ]);
                },
                (element, value) => {

                },
            ));
    </script>
</body>
</html>